---
import BlogCard from "../../ui/blog-card.astro";

const BASE_URL = "http://localhost:1337/api/blog-links";
const STRAPI_URL = "http://localhost:1337";
const PAGE_SIZE = 6;

async function loadData(page: number = 1, pageSize: number = PAGE_SIZE) {
  try {
    const URL = `${BASE_URL}?populate[blogPic][fields][0]=url&pagination[page]=${page}&pagination[pageSize]=${pageSize}&sort=createdAt:desc`;
    const request = await fetch(URL);
    const response = await request.json();
    if (!request.ok) {
      throw new Error("Server is down");
    }
    return {
      data: response?.data || [],
      pagination: response?.meta?.pagination || null,
    };
  } catch (error) {
    console.error(error);
    return { data: [], pagination: null };
  }
}

const { data: blogs, pagination } = await loadData(1, PAGE_SIZE);
const totalPages = pagination?.pageCount || 1;
const serverCurrentPage = pagination?.page || 1;
const hasMore = pagination ? pagination.page < pagination.pageCount : false;
---

<section class="container mx-auto px-5 sm:px-8 lg:px-12 py-20 lg:py-32">
  {/* Header Area with Flex-Adjustment for Mobile */}
  <div
    class="flex flex-col md:flex-row md:items-end justify-between mb-12 md:mb-16 gap-6"
  >
    <div class="max-w-2xl">
      <h2
        class="text-3xl md:text-5xl font-medium text-neutral-950 font-ovo tracking-tight"
      >
        Latest Articles
      </h2>
      <p class="mt-4 text-base md:text-lg text-neutral-600 font-ovo max-w-md">
        Thoughtful writing on development, productivity, and mindset.
      </p>
    </div>

    <a
      href="/blogs"
      class="group flex items-center gap-2 text-sm font-bold uppercase tracking-widest text-neutral-400 hover:text-black transition-colors"
    >
      View Archive
      <span class="w-8 h-px bg-neutral-200 group-hover:bg-black transition-all"
      ></span>
    </a>
  </div>

  {/* Responsive Grid - Adjusted Gap for better white space */}
  <div id="blogs-grid" class="grid gap-x-10 gap-y-16 sm:grid-cols-2 lg:grid-cols-3">
    {
      blogs && blogs.length > 0 ? (
        blogs.map((blog: any) => {
          return (
            <BlogCard
              title={blog.title}
              slug={blog.slug}
              content={blog.content}
              imageUrl={blog?.blogPic?.url}
              publishedAt={blog?.createdAt}
              linkHref={`/blogs/${blog.slug}`}
              linkText="Read Article"
              linkIcon="ArrowRightIcon"
            />
          );
        })
      ) : (
        <div class="col-span-full py-20 text-center border-2 border-dashed border-neutral-100 rounded-3xl">
          <p class="text-neutral-400 font-ovo">
            No articles found at the moment.
          </p>
        </div>
      )
    }
  </div>

  {/* Infinite Scroll Sentinel */}
  {hasMore && (
    <div
      id="scroll-sentinel"
      class="h-10 w-full py-4"
      aria-hidden="true"
    ></div>
  )}
</section>

<script define:vars={{ totalPages, serverCurrentPage, BASE_URL, STRAPI_URL, PAGE_SIZE }}>
  (function () {
    // Wait for DOM to be ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initInfiniteScroll);
    } else {
      initInfiniteScroll();
    }

    function initInfiniteScroll() {
      // Use variables from define:vars
      let pageCounter = serverCurrentPage; // Will be incremented before first fetch
      let isLoading = false;
      let hasMore = serverCurrentPage < totalPages;
      
      console.log('Infinite scroll initialized:', { serverCurrentPage, totalPages, hasMore });

      const blogsGrid = document.getElementById("blogs-grid");
      const sentinel = document.getElementById("scroll-sentinel");

      if (!sentinel || !blogsGrid) {
        console.warn('Infinite scroll: Missing sentinel or blogs-grid element');
        return;
      }
      
      if (!hasMore) {
        console.log('Infinite scroll: No more pages to load');
        if (sentinel) sentinel.remove();
        return;
      }
      
      console.log('Infinite scroll: Elements found', { sentinel, blogsGrid });

      // Helper function to create description from content
      function createDescription(content) {
      if (!content) return "";
      const tempDiv = document.createElement("div");
      tempDiv.innerHTML = content.replace(/<[^>]*>?/gm, "");
      const plainText = tempDiv.textContent || "";
      return plainText.length > 120
        ? plainText.substring(0, 120) + "..."
        : plainText;
    }

      // Helper function to format date
      function formatDate(dateString) {
      if (!dateString) return "";
      return new Date(dateString).toLocaleDateString("en-US", {
        month: "short",
        day: "numeric",
        year: "numeric",
      });
    }

      // Function to create blog card HTML
      function createBlogCardHTML(blog) {
      const imageUrl = blog?.blogPic?.url
        ? `${STRAPI_URL}${blog.blogPic.url}`
        : "/404-fallback.png";
      const publishedDate = formatDate(blog?.createdAt);
      const description = createDescription(blog?.content || "");
      const slug = blog?.slug || "";

      return `
        <article class="group overflow-hidden rounded-2xl border border-neutral-100 bg-white transition-all duration-300 hover:shadow-[0_8px_30px_rgb(0,0,0,0.04)] hover:-translate-y-1">
          <a href="/blogs/${slug}" class="block overflow-hidden">
            <img
              src="${imageUrl}"
              alt="${blog?.title || ""}"
              class="h-56 w-full object-cover transition-transform duration-500 ease-out group-hover:scale-105"
              loading="lazy"
            />
          </a>
          <div class="p-6">
            ${
              publishedDate
                ? `
              <div class="flex items-center gap-2 mb-3">
                <span class="w-1 h-1 rounded-full bg-neutral-400"></span>
                <p class="text-[12px] uppercase tracking-widest text-neutral-500 font-medium font-ovo">
                  ${publishedDate}
                </p>
              </div>
            `
                : ""
            }
            <a href="/blogs/${slug}" class="block">
              <h3 class="text-xl font-semibold text-neutral-900 leading-tight tracking-tight hover:text-neutral-700 transition-colors">
                ${blog?.title || ""}
              </h3>
            </a>
            <p class="mt-3 line-clamp-3 text-sm leading-relaxed text-neutral-600 font-normal font-ovo">
              ${description}
            </p>
            <a
              href="/blogs/${slug}"
              class="mt-5 inline-flex items-center gap-1.5 text-sm font-semibold font-ovo text-black border-b border-transparent hover:border-black transition-all pb-0.5"
            >
              Read Article
              <svg
                class="w-3.5 h-3.5 transition-transform duration-300 group-hover:translate-x-1"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M17 8l4 4m0 0l-4 4m4-4H3"
                />
              </svg>
            </a>
          </div>
        </article>
      `;
    }

      // Function to load more blogs
      async function loadMoreBlogs() {
      if (isLoading || !hasMore) {
        console.log('Load more blocked:', { isLoading, hasMore });
        return;
      }

      console.log('Loading more blogs, page:', pageCounter + 1);
      isLoading = true;
      pageCounter++;

      try {
        const response = await fetch(
          `${BASE_URL}?populate[blogPic][fields][0]=url&pagination[page]=${pageCounter}&pagination[pageSize]=${PAGE_SIZE}&sort=createdAt:desc`
        );
        const result = await response.json();

        if (result.data && result.data.length > 0) {
          const pagination = result.meta?.pagination;
          hasMore = pagination ? pagination.page < pagination.pageCount : false;

          // Append new blog cards to grid
          result.data.forEach((blog) => {
            const blogCardHTML = createBlogCardHTML(blog);
            blogsGrid.insertAdjacentHTML("beforeend", blogCardHTML);
          });

          // If no more pages, remove sentinel
          if (!hasMore && sentinel) {
            sentinel.remove();
          }
        } else {
          hasMore = false;
          if (sentinel) {
            sentinel.remove();
          }
        }
      } catch (error) {
        console.error("Error loading more blogs:", error);
        hasMore = false;
        if (sentinel) {
          sentinel.remove();
        }
      } finally {
        isLoading = false;
      }
    }

      // Intersection Observer setup
      const observerOptions = {
        root: null,
        rootMargin: "200px",
        threshold: 0,
      };

      const observer = new IntersectionObserver((entries) => {
        entries.forEach((entry) => {
          console.log('Sentinel intersection:', { 
            isIntersecting: entry.isIntersecting, 
            hasMore, 
            isLoading 
          });
          if (entry.isIntersecting && hasMore && !isLoading) {
            loadMoreBlogs();
          }
        });
      }, observerOptions);

      // Start observing the sentinel
      console.log('Starting to observe sentinel');
      observer.observe(sentinel);
    }
  })();
</script>

---
import { marked } from "marked";
import Layout from "../../layouts/Layout.astro";
import { Image } from "astro:assets";

// 1. getStaticPaths: Ye build ke waqt batata hai ke kaunse URLs banane hain
export async function getStaticPaths() {
  const API_URL = import.meta.env.PUBLIC_STRAPI_URL;
  
  // Validate API_URL exists and is valid
  if (!API_URL || typeof API_URL !== 'string') {
    console.warn('PUBLIC_STRAPI_URL is not set. Returning empty paths.');
    return [];
  }

  try {
    // Validate URL format
    new URL(API_URL);
  } catch (error) {
    console.warn('PUBLIC_STRAPI_URL is not a valid URL. Returning empty paths.');
    return [];
  }

  try {
    const BLOG_LINKS_URL = `${API_URL}/api/blog-links?populate[blogPic][fields][0]=url`;
    const response = await fetch(BLOG_LINKS_URL);
    
    if (!response.ok) {
      console.warn(`Failed to fetch blog links: ${response.status} ${response.statusText}`);
      return [];
    }
    
    const { data } = await response.json();

    if (!data || !Array.isArray(data)) {
      console.warn('Invalid response format from API');
      return [];
    }

    return data.map((post) => ({
      params: { slug: post.slug }, // URL banay ga: /blogs/how-to-improve-productivity
      props: { post }, // Pura data niche props mein bhejay ga
    }));
  } catch (error) {
    console.error('Error fetching blog links:', error);
    return [];
  }
}

// 2. Data ko receive karein
const { post } = Astro.props;
const STRAPI_URL = import.meta.env.PUBLIC_STRAPI_URL;

// Markdown ko HTML mein convert karein
const contentHTML = await marked.parse(post.content);
---

<Layout title={post?.title}>

  <main class=" min-h-screen pb-20">
    <header
      class="pt-16 md:pt-24 pb-12 container mx-auto px-4 md:px-6 lg:px-12 max-w-5xl"
    >
      <div class="flex items-center gap-3 mb-6">
        <span
          class="px-3 py-1 rounded-full bg-neutral-100 text-[10px] font-bold uppercase tracking-widest text-neutral-500"
        >
          {post?.category || "Article"}
        </span>
        <span class="text-neutral-300">â€¢</span>
        <time class="text-sm font-ovo text-neutral-500">
          {
            new Date(post?.publishedAt).toLocaleDateString("en-US", {
              month: "short",
              day: "numeric",
              year: "numeric",
            })
          }
        </time>
      </div>

      <h1
        class="text-4xl md:text-6xl font-semibold font-ovo leading-[1.1] text-neutral-950 tracking-tight text-balance"
      >
        {post?.title}
      </h1>
    </header>

    <div class="container mx-auto px-4 md:px-6 lg:px-12 max-w-5xl mb-16">
      <div class="rounded-xl overflow-hidden shadow-2xl shadow-neutral-200">
       {post.blogPic ? (
        <Image
          src={STRAPI_URL + post?.blogPic?.url}
          alt={post?.title}
          class="w-full h-[40vh] md:h-[60vh] object-cover"
          width={1000}
          height={800}
          loading="eager"
          fetchpriority="high"
          quality={60}
          format="webp"
        />
       ) : (
        <Image
          src="/404-fallback.png"
          alt="Fallback Image"
          class="w-full h-[40vh] md:h-[67vh] object-cover"
          width={800}
          height={400}
          loading="eager"
          fetchpriority="high"
          quality={60}
          format="webp"
        />
       )}
      </div>
    </div>

    <article class="container mx-auto px-4 md:px-6 lg:px-12 max-w-5xl">
      {/* Markdown Content Yahan Display Hoga */}
      <div
        class="prose prose-neutral prose-lg lg:prose-xl font-ovo  rounded-md leading-relaxed text-neutral-800 max-w-none prose-headings:text-left prose-p:text-gray-600 prose-p:text-base prose-ul:text-left prose-ol:text-left prose-li:text-left"
        set:html={contentHTML}
      />

      <div class="mt-16 pt-8 border-t border-neutral-100 flex flex-wrap gap-2">
        <span class="text-sm font-medium text-neutral-400">Category:</span>
        <span class="text-sm font-medium text-neutral-900">{post.category}</span
        >
      </div>
    </article>
  </main>
</Layout>


